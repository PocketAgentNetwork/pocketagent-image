#!/bin/bash
# PocketAgent Wrapper Script
# This script manages the PocketAgent service on your local machine

# Detect OS and set paths
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    POCKETAGENT_ROOT="/Applications/PocketAgent"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux
    POCKETAGENT_ROOT="$HOME/.local/share/pocketagent"
else
    echo "‚ùå Unsupported OS: $OSTYPE"
    exit 1
fi

POCKETAGENT_HOME="$POCKETAGENT_ROOT/home"
OPENCLAW_PATH="$POCKETAGENT_ROOT/lib/openclaw"
LOG_FILE="$POCKETAGENT_ROOT/logs/pocketagent.log"

export HOME="$POCKETAGENT_HOME"
export XDG_CONFIG_HOME="$HOME/.openclaw"

# Helper function to check if agent is running
is_running() {
    pgrep -f "openclaw.*gateway" > /dev/null
}

# Main command handler
case "$1" in
    start)
        if is_running; then
            echo "üìü PocketAgent is already running"
            exit 0
        fi
        
        echo "üìü Starting PocketAgent..."
        nohup node "$OPENCLAW_PATH/dist/index.js" gateway \
            >> "$LOG_FILE" 2>&1 &
        
        sleep 2
        if is_running; then
            echo "‚úÖ PocketAgent started successfully"
            echo "üåê Access at: http://localhost:18789"
        else
            echo "‚ùå Failed to start PocketAgent"
            echo "Check logs: pocketagent logs"
            exit 1
        fi
        ;;
    
    stop)
        if ! is_running; then
            echo "üìü PocketAgent is not running"
            exit 0
        fi
        
        echo "üìü Stopping PocketAgent..."
        pkill -f "openclaw.*gateway"
        sleep 1
        
        if ! is_running; then
            echo "‚úÖ PocketAgent stopped"
        else
            echo "‚ö†Ô∏è  Force stopping..."
            pkill -9 -f "openclaw.*gateway"
            echo "‚úÖ PocketAgent stopped"
        fi
        ;;
    
    restart)
        echo "üìü Restarting PocketAgent..."
        "$0" stop
        sleep 2
        "$0" start
        ;;
    
    status)
        if is_running; then
            PID=$(pgrep -f "openclaw.*gateway")
            echo "üìü PocketAgent is running (PID: $PID)"
            echo "üåê Access at: http://localhost:18789"
        else
            echo "üìü PocketAgent is stopped"
        fi
        ;;
    
    logs)
        if [ ! -f "$LOG_FILE" ]; then
            echo "‚ùå Log file not found: $LOG_FILE"
            exit 1
        fi
        
        case "$2" in
            --follow|-f)
                tail -f "$LOG_FILE"
                ;;
            --tail)
                tail -n "${3:-100}" "$LOG_FILE"
                ;;
            *)
                tail -n 50 "$LOG_FILE"
                ;;
        esac
        ;;
    
    update)
        echo "üìü Updating PocketAgent..."
        echo ""
        
        # Stop agent
        if is_running; then
            echo "  Stopping agent..."
            "$0" stop
        fi
        
        # Backup current OpenClaw
        if [ -d "$OPENCLAW_PATH" ]; then
            BACKUP_NAME="openclaw.backup.$(date +%Y%m%d-%H%M%S)"
            echo "  Backing up current version to: $BACKUP_NAME"
            mv "$OPENCLAW_PATH" "$POCKETAGENT_ROOT/lib/$BACKUP_NAME"
        fi
        
        # Get tested OpenClaw version from PocketAgent repo
        echo "  Fetching tested OpenClaw version..."
        OPENCLAW_VERSION=$(curl -fsSL https://raw.githubusercontent.com/PocketAgentNetwork/pocketagent-image/main/OPENCLAW_VERSION)
        
        if [ -z "$OPENCLAW_VERSION" ]; then
            echo "‚ùå Failed to fetch OpenClaw version"
            echo "  Restoring backup..."
            mv "$POCKETAGENT_ROOT/lib/$BACKUP_NAME" "$OPENCLAW_PATH"
            exit 1
        fi
        
        echo "  Downloading OpenClaw $OPENCLAW_VERSION..."
        cd "$POCKETAGENT_ROOT/lib"
        
        # Download release tarball
        if ! curl -fsSL "https://github.com/openclaw/openclaw/archive/refs/tags/$OPENCLAW_VERSION.tar.gz" -o openclaw.tar.gz; then
            echo "‚ùå Failed to download OpenClaw"
            echo "  Restoring backup..."
            mv "$POCKETAGENT_ROOT/lib/$BACKUP_NAME" "$OPENCLAW_PATH"
            exit 1
        fi
        
        # Extract
        tar -xzf openclaw.tar.gz
        mv "openclaw-${OPENCLAW_VERSION#v}" openclaw
        rm openclaw.tar.gz
        
        cd openclaw
        
        # Save version info
        echo "$OPENCLAW_VERSION" > "$POCKETAGENT_ROOT/OPENCLAW_VERSION"
        
        # Build
        echo "  Building OpenClaw..."
        if ! pnpm install; then
            echo "‚ùå Failed to install dependencies"
            exit 1
        fi
        
        if ! pnpm build; then
            echo "‚ùå Failed to build OpenClaw"
            exit 1
        fi
        
        # Restart
        echo "  Restarting agent..."
        "$0" start
        
        echo ""
        echo "‚úÖ Updated to OpenClaw $OPENCLAW_VERSION!"
        echo "   Your data and settings are preserved."
        echo "   Backup saved: $BACKUP_NAME"
        ;;
    
    fix-context)
        echo "üìü Fixing model context window..."
        cd "$OPENCLAW_PATH"
        node dist/index.js config set models.providers.pocketagent-local.models.0.contextWindow 128000
        node dist/index.js config set models.providers.pocketagent-local.models.0.maxTokens 128000
        echo ""
        echo "‚úÖ Context window updated to 128000 tokens"
        echo "   Restart PocketAgent to apply: pocketagent restart"
        ;;
    
    version)
        if [ -d "$OPENCLAW_PATH/.git" ]; then
            cd "$OPENCLAW_PATH"
            COMMIT=$(git rev-parse --short HEAD)
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            echo "üìü PocketAgent (OpenClaw)"
            echo "   Branch: $BRANCH"
            echo "   Commit: $COMMIT"
        else
            echo "‚ùå Unable to determine version"
        fi
        ;;
    
    doctor)
        if ! is_running; then
            echo "‚ö†Ô∏è  PocketAgent is not running"
            echo "   Start it with: pocketagent start"
            exit 1
        fi
        
        cd "$OPENCLAW_PATH"
        node dist/index.js doctor "$@"
        ;;
    
    models|config|workspace|skills|integrations|health)
        if ! is_running; then
            echo "‚ö†Ô∏è  PocketAgent is not running"
            echo "   Start it with: pocketagent start"
            exit 1
        fi
        
        cd "$OPENCLAW_PATH"
        node dist/index.js "$@"
        ;;
    
    --help|-h|help)
        cat << EOF
üìü PocketAgent - Local AI Agent

Usage: pocketagent <command> [options]

Commands:
  start              Start PocketAgent service
  stop               Stop PocketAgent service
  restart            Restart PocketAgent service
  status             Check if PocketAgent is running
  logs               View logs (--follow, --tail N)
  update             Update to latest OpenClaw version
  version            Show current version
  fix-context        Fix model context window (set to 128k tokens)
  
  doctor             Run diagnostics (--fix to auto-fix)
  models             Manage AI models
  config             View/edit configuration
  workspace          Manage workspace
  skills             Manage skills
  integrations       Manage integrations
  health             Check agent health
  
  --help, -h         Show this help message

All other OpenClaw commands are also available:
  pocketagent <openclaw-command> [options]
  
  Examples:
    pocketagent channels login
    pocketagent message send --target +1234567890 --message "Hi"
    pocketagent agents list
    pocketagent browser open

Examples:
  pocketagent start
  pocketagent logs --follow
  pocketagent update
  pocketagent models status
  pocketagent doctor --fix
  pocketagent fix-context

Web UI: http://localhost:18789
EOF
        ;;
    
    *)
        # Pass any other command directly to openclaw
        if [ "$1" != "" ]; then
            cd "$OPENCLAW_PATH"
            node dist/index.js "$@"
        else
            echo "‚ùå No command specified"
            echo "Run 'pocketagent --help' for usage"
            exit 1
        fi
        ;;
esac
